format: "0.2.0"
version: "0.0.1"

fhirConfig:
  resource: "Condition"
  multiple: true
  condition:
    - targetRoot: "$fhirResource"
      targetAttribute: "extension.url"
      operator: "one of"
      criteria: "[http://hl7.org/fhir/StructureDefinition/condition-related]"
openEhrConfig:
  archetype: "openEHR-EHR-EVALUATION.problem_diagnosis.v1"

mappings:

  - name: "sekundar"
    with:
      fhir: "$fhirResource"
      openehr: "$openEhrArchetype.diagnose"
      type: "NONE"
    slotArchetype: "openEHR-EHR-EVALUATION.problem_diagnosis.v1"




  - name: "encounter reference"
    with:
      fhir: "$fhirResource.encounter"
      openehr: "$openEhrArchetype.fall_kennung" # when mapping to openEHR, this will be expected to be Composition UUID
      type: "AQL"
      aql: "SELECT c/uid/value FROM COMPOSITION c CONTAINS OBSERVATION o[openEHR-EHR-OBSERVATION.problem_diagnosis.v1] WHERE c/archetype_details/archetype_id/value = 'openEHR-EHR-COMPOSITION.encounter.v1' AND c/context/start_time/value >= '2023-01-01T00:00:00' AND c/context/start_time/value <= '2024-01-01T00:00:00' AND o/data[at0001]/items[at0002]/value/value = 'Diabetes mellitus'" #with a caching logic so we don't do redundant AQLs every time someone sends the same thing





  - name: "condition type terminology"
    with:
      openehr: "$openEhrArchetype.diagnose.klinischer_status.referenzprimaerdiagnose|terminology"
      value: "local"
  - name: "condition type code"
    with:
      openehr: "$openEhrArchetype.diagnose.klinischer_status.referenzprimaerdiagnose|code"
      value: "at0066"
  - name: "condition type value"
    with:
      openehr: "$openEhrArchetype.diagnose.klinischer_status.referenzprimaerdiagnose|value"
      value: "Nebendiagnose"

  - name: "sekundÃ¤rcode"
    with:
      fhir: "$fhirResource.extension"
      openehr: "$openEhrArchetype.diagnose"
      type: "NONE"
    condition:
      targetRoot: "$fhirResource.extension"
      targetAttribute: "url"
      operator: "one of"
      criteria: "[http://hl7.org/fhir/StructureDefinition/condition-related]"
    followedBy:
      mappings:
        - name: "condition type terminology"
          with:
            openehr: "$openEhrArchetype.diagnose.klinischer_status.referenzprimaerdiagnose|terminology"
            value: "local"
        - name: "condition type code"
          with:
            openehr: "$openEhrArchetype.diagnose.klinischer_status.referenzprimaerdiagnose|code"
            value: "at0064"
        - name: "condition type value"
          with:
            openehr: "$openEhrArchetype.diagnose.klinischer_status.referenzprimaerdiagnose|value"
            value: "Hauptdiagnose"


        - name: "referenced condition"
          with:
            fhir: "value"
            openehr: "$reference"
            type: "NONE"
          reference:
            resourceType: "Condition"
            mappings:
              - name: "primary"
                with:
                  fhir: "$fhirRoot"
                  openehr: "$openEhrArchetype"
                  type: "NONE"
                slotArchetype: "openEHR-EHR-EVALUATION.problem_diagnosis.v1"
