engine: FHIRConnect/v0.0.1
type: model
metadata:
  name: OBSERVATION.laboratory_test_result.v1
  version: 0.0.1a # version of this particular mapping
spec: # schema specific to the FHIRConnect v0.0.1 engine
  system: FHIR
  version: R4
  openEhrConfig:
    archetype: openEHR-EHR-OBSERVATION.laboratory_test_result.v1
  fhirConfig:
    structureDefinition: http://hl7.org/fhir/StructureDefinition/DiagnosticReport
    multiple: false # whether output of openEHR -> FHIR should return multiple Resources or a single one.

mappings:

  - name: "healthCareFacility"
    with:
      fhir: "$resource.performer.as(Reference).display"
      openehr: "$composition/context/_health_care_facility|name"
      type: "STRING"

  #  - name: "participations"
  #    with:
  #      fhir: "$resource.resultsInterpreter"
  #      openehr: "$archetype/context/participations"
  #    participationsFunction: "results Interpreter"

  # todo: this is overriding itself below?
  - name: "composer"
    with:
      fhir: "$resource.performer.as(Reference).display"
      openehr: "$composition/composer|name" #take the first one if its 0..n ?!
      type: "STRING"

  - name: "performer"
    with:
      fhir: "$resource.performer.as(Reference).display"
      openehr: "$composition/perfomer"
      type: "STRING"

  #  - name: "otherParticipants"
  #    with:
  #      fhir: "$resource.resultsInterpreter"
  #      openehr: "$archetype/other_participations"
  #    participationsFunction: "results Interpreter"

  - name: "effective"
    with:
      fhir: "$resource.effective.as(Period)"
      openehr: "$composition"
    followedBy:
      mappings:
        - name: "effectiveEnd"
          with:
            fhir: "end"
            openehr: "context/_end_time"
            type: "DATETIME"

        - name: "effectiveStart"
          with:
            fhir: "start"
            openehr: "context/start_time"
            type: "DATETIME"



  - name: "category"
    with:
      fhir: "$resource.category"
      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0005]" # if there are several events add it to all of them
      type: "CODEABLECONCEPT"
      # Backwards map all the values back, if they overlap ?!?!?!?

  - name: "status" #deprecated needs to go once mapping is updated
    with:
      fhir: "$resource.status"
      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"


#  - name: "status_registered_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "registered"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0107"
#
#  - name: "status_partial_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "partial"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0037"
#
#  - name: "status_preliminary_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "preliminary"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0120"
#
#  - name: "status_final_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "final"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0038"
#
#  - name: "status_amended_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "amended"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0040"
#
#  - name: "status_corrected_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "corrected"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0115"
#
#  - name: "status_appended_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "appended"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0119"
#
#  - name: "status_cancelled_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "cancelled"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0074"
#
#  - name: "status_entered_in_error_fhir"
#    with:
#      fhir: "$resource.status"
#      value: "entered-in-error"
#    openehrCondition:
#      targetRoot: "$archetype"
#      targetAttributes:
#        - "data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      operator: "one of"
#      criteria: "at0116"
#
#  - name: "status_registered_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0107"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "registered"
#
#
#  - name: "status_partial_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0037"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "partial"
#
#  - name: "status_preliminary_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0120"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "preliminary"
#
#  - name: "status_final_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0038"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "final"
#
#  - name: "status_amended_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0040"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "amended"
#
#  - name: "status_corrected_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0115"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "corrected"
#
#  - name: "status_appended_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0119"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "appended"
#
#  - name: "status_cancelled_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0074"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "cancelled"
#
#  - name: "status_entered_in_error_openehr"
#    with:
#      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0073]/value/defining_code"
#      value: "at0116"
#    fhirCondition:
#      targetRoot: "$fhirRoot"
#      targetAttributes:
#        - "status"
#      operator: "one of"
#      criteria: "entered-in-error"



  - name: "conclusion"
    with:
      fhir: "$resource.conclusion"
      openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[at0057]"
      type: "STRING"

  - name: "issued"
    with:
      fhir: "$resource.issued"
      openehr: "$archetype/data[at0001]/events[at0002]/time"
      type: "DATETIME"

  - name: "specimen"
    with:
      fhir: "$resource.specimen"
      openehr: "$reference"
      type: "NONE"
    reference:
      resourceType: "Specimen"
      mappings:
        - name: "specimenReference"
          with:
            fhir: "$fhirRoot"
            openehr: "$archetype/data[at0001]/events[at0002]/data[at0003]/items[openEHR-EHR-CLUSTER.specimen.v1]"
          slotArchetype: "CLUSTER.specimen.v1"

  - name: "basedOn"
    extension: "add"
    with:
      fhir: "$resource.basedOn.as(Reference)"
      openehr: "$archetype"
    followedBy: # type automatic since not provided, if no profile url is registered skip mapping
      mappings:
        - name: "identifierInReference"
          with:
            fhir: "identifier"
            openehr: "protocol[at0004]/items[at0094]/items[at0063]"
            type: "IDENTIFIER"
#        - name: "basedOnLink"
#          with:
#            fhir: "$fhirRoot"
#            openehr: "$archetype/protocol[at0004]/items[at0094]/items[at0063]/links"
#            type: "REFERENCED_MAPPING"
#            openehrLink:
#              meaning: "the identifier which it derived from"
#              type: "based on"

