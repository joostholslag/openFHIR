engine: FHIRConnect/v0.0.1
type: model
metadata:
  name: CLUSTER.specimen.v1
  version: 0.0.1a
spec:
  system: FHIR
  version: R4
  openEhrConfig:
    archetype: openEHR-EHR-CLUSTER.specimen.v1
  fhirConfig:
    structureDefinition: http://hl7.org/fhir/StructureDefinition/BackboneElement

mappings:
  - name: "identifier"
    with:
      fhir: "$resource.identifier"
      openehr: "$archetype/items[at0088]" #external identifier
      type: "IDENTIFIER"

  - name: "collection"
    with:
      fhir: "$resource.collection"
      openehr: "$archetype"
      type: "NONE"
    followedBy:
      mappings:
        - name: "collected"
          with:
            fhir: "collected.as(DateTimeType)" # same as onset; try to provide both and use the one that's present
            openehr: "items[at0015]"
            type: "DATETIME"

        - name: "collector"
          with:
            fhir: "collector.as(Reference).identifier" # explicitly cast to Reference to avoid adding a Resource
            openehr: "items[at0070]" #TODO should in the best case pinpoint to a resource via link, dunno where to put this in openEHR currently
            type: "IDENTIFIER"

        - name: "specimenCollectionMethod"
          with:
            fhir: "method.text"
            openehr: "items[at0007]"
            type: "STRING"

        - name: "specimenCollectionBodySite"
          with:
            fhir: "bodySite.text"
            openehr: "items[at0087, 'KÃ¶rperstelle']"
            type: "STRING"

        - name: "samplingContext"
          with:
            fhir: "fastingStatus.as(CodeableConcept).text"
            openehr: "items[at0008]" #Sampling context
            type: "STRING"

  - name: "type"
    with:
      fhir: "$resource.type"
      openehr: "$archetype/items[at0029]" # specimen type
      type: "CODEABLECONCEPT"

  - name: "note"
    with:
      fhir: "$resource.note.text"
      openehr: "$archetype/items[at0045]" # comment
      type: "STRING"

  - name: "descriptionOfSpecimen"
    with:
      fhir: "$resource.condition"
      openehr: "$archetype/items[at0097]" #specimen description
      type: "CODEABLECONCEPT"

  - name: "identifierOfSpecimen"
    with:
      fhir: "$resource.accessionIdentifier"
      openehr: "$archetype/items[at0001]" #Laboratory specimen identifier
      type: "IDENTIFIER"

  - name: "dateReceived"
    with:
      fhir: "$resource.receivedTime"
      openehr: "$archetype/items[at0034]" #Date/Time received
      type: "DATETIME"

  - name: "parent"
    with:
      fhir: "$resource.parent.as(Reference).identifier.value"
      openehr: "$archetype/items[at0003]"
      type: "STRING"

  - name: "status"
    with:
      fhir: "$resource.status"
      openehr: "$archetype/items[at0041]|code" #adequacy for testing
      type: "STRING"

  - name: "status_fhir_available"
    with:
      fhir: "$resource.status"
      value: "available"
    openehrCondition:
      targetRoot: "$archetype"
      targetAttributes:
        - "items[at0041]/defining_code"
      operator: "one of"
      criteria: "at0062"

  - name: "status_fhir_unavailable"
    with:
      fhir: "$resource.status"
      value: "unavailable"
    openehrCondition:
      targetRoot: "$archetype"
      targetAttributes:
        - "items[at0041]/defining_code"
      operator: "one of"
      criteria: "at0064"

  - name: "status_fhir_unsatisfactory"
    with:
      fhir: "$resource.status"
      value: "unsatisfactory"
    openehrCondition:
      targetRoot: "$archetype"
      targetAttributes:
        - "items[at0041]/defining_code"
      operator: "one of"
      criteria: "at0064"

  - name: "status_openehr_available_code"
    with:
      openehr: "$archetype/items[at0041]/defining_code"
      value: "at0062"
    fhirCondition:
      targetRoot: "$fhirRoot"
      targetAttributes:
        - "status"
      operator: "one of"
      criteria: "available"
  - name: "status_openehr_available_value"
    with:
      openehr: "$archetype/items[at0041]/value"
      value: "Satisfactory"
    fhirCondition:
      targetRoot: "$fhirRoot"
      targetAttributes:
        - "status"
      operator: "one of"
      criteria: "available"

  - name: "status_openehr_unavailable_code"
    with:
      openehr: "$archetype/items[at0041]/defining_code"
      value: "at0064"
    fhirCondition:
      targetRoot: "$fhirRoot"
      targetAttributes:
        - "status"
      operator: "one of"
      criteria: "unavailable"
  - name: "status_openehr_unavailable_value"
    with:
      openehr: "$archetype/items[at0041]/value"
      value: "Unsatisfactory - not analysed"
    fhirCondition:
      targetRoot: "$fhirRoot"
      targetAttributes:
        - "status"
      operator: "one of"
      criteria: "unavailable"

  - name: "status_openehr_unsatisfactory_code"
    with:
      openehr: "$archetype/items[at0041]/defining_code"
      value: "at0064"
    fhirCondition:
      targetRoot: "$fhirRoot"
      targetAttributes:
        - "status"
      operator: "one of"
      criteria: "unsatisfactory"
  - name: "status_openehr_unsatisfactory_value"
    with:
      openehr: "$archetype/items[at0041]/value"
      value: "Unsatisfactory - not analysed"
    fhirCondition:
      targetRoot: "$fhirRoot"
      targetAttributes:
        - "status"
      operator: "one of"
      criteria: "unsatisfactory"






  - name: "status_openehr_available_terminology"
    with:
      openehr: "$archetype/items[at0041]/terminology_id"
      value: "local"


