engine: FHIRConnect/v0.0.1
type: model
metadata:
  name: CLUSTER.specimen.v1
  version: 0.0.1a
spec:
  system: FHIR
  version: R4
  openEhrConfig:
    archetype: openEHR-EHR-CLUSTER.specimen.v1
  fhirConfig:
    structureDefinition: http://hl7.org/fhir/StructureDefinition/Person #todo if we make this Organization, it also means it will try to map fhir->openehr standalone organization without the context of a template (resulting in leistungsanforderung/identifikator_des_probenehmers|id, leistungsanforderung/zeitpunkt_der_probenentnahme/date_time_value).. what do we do?

mappings:
  - name: "identifier"
    with:
      fhir: "$resource.identifier"
      openehr: "$archetype.externer_identifikator" #external identifier
      type: "IDENTIFIER"

  - name: "collection"
    with:
      fhir: "$resource.collection"
      openehr: "$archetype"
      type: "NONE"
    followedBy:
      mappings:
        - name: "collected"
          with:
            fhir: "collected.as(DateTimeType)" # same as onset; try to provide both and use the one that's present
            openehr: "$archetype.zeitpunkt_der_probenentnahme.date_time_value"
            type: "DATETIME"

        - name: "collector"
          with:
            fhir: "collector.as(Reference).identifier" # explicitly cast to Reference to avoid adding a Resource
            openehr: "$archetype.identifikator_des_probenehmers" #TODO should in the best case pinpoint to a resource via link, dunno where to put this in openEHR currently
            type: "IDENTIFIER"

        - name: "specimenCollectionMethod"
          with:
            fhir: "method.text"
            openehr: "$archetype.probenentnahmemethode"
            type: "STRING"

        - name: "specimenCollectionBodySite"
          with:
            fhir: "bodySite.text"
            openehr: "$archetype.k√∂rperstelle"
            type: "STRING"

        - name: "samplingContext"
          with:
            fhir: "fastingStatus.as(CodeableConcept).text"
            openehr: "$archetype.probenentahmebedingung" #Sampling context
            type: "STRING"

#        - name: "collector"
#          with:
#            fhir: "collector.reference"
#            openehr: "$reference"
#          reference:
#            mappings:
#              - name: "identifierInReference"
#                with:
#                  fhir: "$resource.identifier"
#                  openehr: "$archetype/items[at0070]"
#              - name: "collectorLink"
#                with:
#                  fhir: "$resource"
#                  openehr: "$archetype/items[at0070]/links"
#                  type: "REFERENCED_MAPPING"
#                  openehrLink:
#                    meaning: "the collector that collected this specimen"
#                    type: "collector"

  - name: "type"
    with:
      fhir: "$resource.type"
      openehr: "$archetype.probenart" # specimen type
      type: "CODEABLECONCEPT"

  - name: "note"
    with:
      fhir: "$resource.note.text"
      openehr: "$archetype.kommentar" # comment
      type: "STRING"

  - name: "descriptionOfSpecimen"
    with:
      fhir: "$resource.condition"
      openehr: "$archetype.beschreibung_der_probe" #specimen description
      type: "CODEABLECONCEPT"

  - name: "identifierOfSpecimen"
    with:
      fhir: "$resource.accessionIdentifier"
      openehr: "$archetype.laborprobenidentifikator" #Laboratory specimen identifier
      type: "IDENTIFIER"

  - name: "dateReceived"
    with:
      fhir: "$resource.receivedTime"
      openehr: "$archetype.zeitpunkt_des_probeneingangs" #Date/Time received
      type: "DATETIME"

#  - name: "parent"
#    with:
#      fhir: "$resource.parent.reference"
#      openehr: "$reference"
#    reference:
#      resourceType: "Specimen"
#      mappings:
#        - name: "referenceInIdentifier"
#          with:
#            fhir: "$resource.identifier"
#            openehr: "$archetype/items[at0003]"
#        - name: "parentLink"
#          with:
#            fhir: "$resource"
#            openehr: "$archetype/items[at0003]/links"
#            type: "REFERENCED_MAPPING"
#            openehrLink:
#              meaning: "the parent of this specimen"
#              type: "parent"

  - name: "status"
    with:
      fhir: "$resource.status"
      openehr: "$archetype.eignung_zur_analyse|code" #adequacy for testing
      type: "STRING"

