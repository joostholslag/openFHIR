engine: FHIRConnect/v0.0.1
type: model
metadata:
  name: specimen
  version: 0.0.1a
spec:
  system: FHIR
  version: R4
  openEhrConfig:
    archetype: openEHR-EHR-CLUSTER.specimen.v1
  fhirConfig:
    profile: http://hl7.org/fhir/StructureDefinition/Specimen

mappings:
  - name: "identifier"
    with:
      fhir: "$resource.identifier"
      openehr: "$archetype/items[at0088]" #external identifier

  - name: "collection"
    with:
      fhir: "$resource.collection"
      openehr: "$archetype"
      type: "NONE"
    followedBy:
      mappings:
        - name: "collectionDateTime"
          with:
            fhir: "collected" # same as onset; try to provide both and use the one that's present
            openehr: "/items[at0015]"
        - name: "collector"
          with:
            fhir: "collector.as(Reference).identifier" # explicitly cast to Reference to avoid adding a Resource
            openehr: "/items[at0070]" #TODO should in the best case pinpoint to a resource via link, dunno where to put this in openEHR currently
        - name: "specimenCollectionMethod"
          with:
            fhir: "method"
            openehr: "/items[at0007]"
        - name: "specimenCollectionBodySite"
          with:
            fhir: "bodySite"
            openehr: "/items[at0087]"
        - name: "samplingContext"
          with:
            fhir: "fastingStatus"
            openehr: "$archetype/items[0008]" #Sampling context
        - name: "collector"
          with:
            fhir: "collector"
            openehr: "$reference"
          reference:
            mappings:
              - name: "identifierInReference"
                with:
                  fhir: "$fhirRoot.identifier"
                  openehr: "$archetype/items[at0070]"
              - name: "collectorLink"
                with:
                  fhir: "$fhirRoot"
                  openehr: "$archetype/items[at0070]/links"
                  type: "REFERENCED_MAPPING"
                  openehrLink:
                    meaning: "the collector that collected this specimen"
                    type: "collector"

  - name: "type"
    with:
      fhir: "$resource.type"
      openehr: "$archetype/items[at0029]" # specimen type

  - name: "note"
    with:
      fhir: "$resource.note"
      openehr: "$archetype/items[at0045]" # comment

  - name: "descriptionOfSpecimen"
    with:
      fhir: "$resource.condition"
      openehr: "$archetype/items[at0097]" #specimen description

  - name: "descriptionOfSpecimen"
    with:
      fhir: "$resource.accessionIdentifier"
      openehr: "$archetype/items[0001]" #Laboratory specimen identifier

  - name: "dateReceived"
    with:
      fhir: "$resource.receivedTime"
      openehr: "$archetype/items[at0034]" #Date/Time received

  - name: "parent"
    with:
      fhir: "$resource.parent"
      openehr: "$reference"
    reference:
      resourceType: "Specimen"
      mappings:
        - name: "referenceInIdentifier"
          with:
            fhir: "$fhirRoot.identifier"
            openehr: "$archetype/items[at0003]"
        - name: "parentLink"
          with:
            fhir: "$fhirRoot"
            openehr: "$archetype/items[at0003]/links"
            type: "REFERENCED_MAPPING"
            openehrLink:
              meaning: "the parent of this specimen"
              type: "parent"

  - name: "status"
    with:
      fhir: "$resource.status"
      openehr: "archetypePath/items[at0041]" #adequacy for testing

