format: "0.2.0"
version: "0.0.1"

fhirConfig:
  resource: "MedicationStatement"
openEhrConfig:
  archetype: "openEHR-EHR-OBSERVATION.medication_statement.v0"

mappings:
  - name: "identifier"
    with:
      fhir: "$resourcePath.identifier"
      openehr: "$archetypePath.medikationseintrag.identifier.externer_identifier"
      type: "IDENTIFIER"
    condition:
      targetRoot: "$resourcePath.identifier"
      targetAttribute: "system"
      operator: "one of"
      criteria: "[external identifier]"

  - name: "description"
    with:
      fhir: "$resourcePath.note.text"
      openehr: "$archetypePath.medikationseintrag.beschreibung"

  #order for structured dosage matters; it needs to be ABOVE "unstructured dosage" because of openEhrPaths being so similar (belows openehr path is actually within aboves)

  - name: "structured dosage"
    with:
      fhir: "$resourcePath.dosage"
      openehr: "$archetypePath.medikationseintrag.dosierung2"
      type: "NONE"
    slotArchetype: "openEHR-EHR-CLUSTER.dosage.v2"

  - name: "unstructured dosage"
    with:
      fhir: "$resourcePath.dosage.text"
      openehr: "$archetypePath.medikationseintrag.dosierung"
      type: "STRING"

  - name: "effective"
    with:
      fhir: "$resourcePath.effective.as(Period)"
      openehr: "$archetypePath.medikationseintrag"
      type: "NONE"
    followedBy:
      mappings:
        - name: "start effective"
          with:
            fhir: "start"
            openehr: "startzeitpunkt_einnahme"
            type: "DATETIME"
        - name: "end effective"
          with:
            fhir: "end"
            openehr: "endzeitpunkt_einnahme"
            type: "DATETIME"


# order is important, because when mapping from openEHR to FHIR, we want the second mapping (better one) to be applied
  - name: "medication"
    with:
      fhir: "$resourcePath.medication.as(CodeableConcept).text"
      openehr: "$archetypePath.medikationseintrag.arzneimittel.arzneimittel-name"
      type: "STRING"

  - name: "medication"
    with:
      fhir: "$resourcePath.medication"
      openehr: "$reference"
    reference:
      resourceType: "Medication"
      mappings:
        - name: "medication request medication"
          with:
            fhir: "$fhirRoot"
            openehr: "$archetypePath.medikationseintrag.arzneimittel"
            type: "NONE"
          slotArchetype: "openEHR-EHR-CLUSTER.medication.v2"


