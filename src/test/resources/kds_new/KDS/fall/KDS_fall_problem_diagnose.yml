engine: FHIRConnect/v0.0.1
type: extension
metadata:
  name: KDS_fall_problem_diagnose
  version: 0.0.1a
spec:
  system: FHIR
  version: R4
  extension:
    extends: EVALUATION.problem_diagnosis.v1
    inheritance: "exclusive" # execute only the mappings that are in this file, other ones are not used

mappings:
  - name: "problemDiagnose"
    extension: "overwrite"
    with:
      fhir: "$fhirParentPath"
      openehr: "$archetype"
      type: "NONE"
    followedBy:
      mappings:
        - name: "referencedDiagnose" # condition reference
          with:
            fhir: "condition"
            openehr: "$reference"
          reference:
            resourceType: "Condition"
            mappings:
              - name: "referencedDiagnose"
                with:
                  fhir: "$fhirRoot"
                  openehr: "/data[at0001]/links"
                  type: "REFERENCED_MAPPING"
                  openehrLink:
                    meaning: "link to the diagnosis composition"
                    type: "diagnose"
        - name: "diagnoseName" # use fields etc. CANT reuse cluster mappings since this is not a clear condition to problem dia mapping
          with:
            fhir: "condition.code" #TODO @Gasper is this correctly how i can access the code in the Condition reference FHIR
            openehr: "/data[at0001]/items[at0002]"
        - name: "diagnoseTyp" # use fields etc. CANT reuse cluster mappings since this is not a clear condition to problem dia mapping
          with:
            fhir: "use.coding.code"
            openehr: "/data[at0001]/items[at0009]"
          condition:
            targetRoot: "use.coding.code"
            targetAttribute: "value"
            operator: "one of"
            criteria: "[referral-diagnosis, treatment-diagnosis]"
        - name: "diagnoseSubtyp" # use fields etc. CANT reuse cluster mappings since this is not a clear condition to problem dia mapping
          with:
            fhir: "use.coding.code"
            openehr: "/data[at0001]/items[at0079]"
          condition:
            targetRoot: "use.coding.code"
            targetAttribute: "value"
            operator: "one of"
            criteria: "[surgery-diagnosis, department-main-diagnosis, cause-of-death, infection-control-diagnosis, AD, DD]"

