format: "0.2.0"
version: "0.0.1"

fhirConfig:
  resource: "MedicationAdministration"
  multiple: false
openEhrConfig:
  archetype: "openEHR-EHR-ACTION.medication.v1"

mappings:
  - name: "status"
    with:
      fhir: "$resourcePath.status"
      openehr: "$archetypePath.context.status"
      type: "CODING"

  - name: "context"
    with:
      fhir: "$resourcePath.context.as(Reference).reference"
      openehr: "$archetypePath.context.fallidentifikation.fall-kennung"
      type: "STRING"

  - name: "effective"
    with:
      fhir: "$resourcePath.effective.as(DateTimeType)"
      openehr: "$archetypePath.arzneimittelanwendung.dosierung.zeitablauf_-_täglich.verabreichungszeitpunkt_-intervall/time_value"
      type: "TIME"

  #order for structured dosage matters; it needs to be ABOVE "unstructured dosage" because of openEhrPaths being so similar (belows openehr path is actually within aboves)

  - name: "structured dosage"
    with:
      fhir: "$resourcePath.dosage"
      openehr: "$archetypePath.arzneimittelanwendung"
      type: "NONE"
    slotArchetype: "openEHR-EHR-CLUSTER.dosage.v2"
    followedBy:
      mappings:
        - name: "route"
          with:
            fhir: "route"
            openehr: "arzneimittel.wirkstoff.wirkstoff-code_ask_snomed_ct_unii_cas/wirkstoff-code"
            type: "CODEABLECONCEPT"
        - name: "site"
          with:
            fhir: "site"
            openehr: "arzneimittel.wirkstoff.wirkstoff-code_ask_snomed_ct_unii_cas/wirkstoff-code"
            type: "CODEABLECONCEPT"

        - name: "rate"
          with:
            fhir: "rate.as(Ratio)"
            openehr: "arzneimittel.wirkstoff.wirkstoffmenge"
            type: "NONE"
          followedBy:
            mappings:
              - name: "zahler"
                with:
                  fhir: "numerator"
                  openehr: "zähler"
                  type: "QUANTITY"
              - name: "nenner"
                with:
                  fhir: "denominator"
                  openehr: "nenner"
                  type: "QUANTITY"

#        - name: "rate quantity"
#          with:
#            fhir: "rate.as(Quantity)"
#            openehr: "dosierung.verabreichungsrate.quantity_value"
#            type: "QUANTITY"

  - name: "note"
    with:
      fhir: "$resourcePath.note.text"
      openehr: "$archetypePath.arzneimittelanwendung.kommentar"
      type: "STRING"

  - name: "klinische_indikation"
    with:
      fhir: "$resourcePath.reasonCode.text"
      openehr: "$archetypePath.arzneimittelanwendung.klinische_indikation"
      type: "STRING"

  - name: "medication"
    with:
      fhir: "$resourcePath.medication"
      openehr: "$reference"
    reference:
      resourceType: "Medication"
      mappings:
        - name: "medication administration medication"
          with:
            fhir: "$fhirRoot"
            openehr: "$archetypePath.arzneimittelanwendung.arzneimittel"
            type: "NONE"
          slotArchetype: "openEHR-EHR-CLUSTER.medication.v2"

  - name: "medication codeable concept"
    with:
      fhir: "$resourcePath.medication.as(CodeableConcept).text"
      openehr: "$archetypePath.arzneimittelanwendung.arzneimittel.arzneimittelgruppe.arzneimittel-code"
      type: "STRING"
