engine: FHIRConnect/v0.0.1
type: context
metadata:
  name:  KDS_Diagnose
  version: 0.0.1a # version of this particular mapping
spec: # schema specific to the FHIRConnect v0.0.1 engine
  system: FHIR
  version: R4

openEHR:
  templateId: "KDS_Diagnose"
  archetypes:
    - "openEHR-EHR-CLUSTER.multiple_coding_icd10gm.v1" # i dont think we need to list clusters here ? 
    - "openEHR-EHR-CLUSTER.lebensphase.v0"
  profiles: 
    - "KDS_problem_diagnosis" #they overload the vanilla mappings, no version = take the latest
    - "KDS_anatomical_location" 
    - "KDS_problem_qualifier"

fhir:
  resourceType: "Bundle"
  condition:
    targetRoot: "$fhirResource"
    targetAttribute: "entry.resource.meta.profile"
    operator: "one of"
    criteria: "[https://www.medizininformatik-initiative.de/fhir/core/modul-diagnose/StructureDefinition/Diagnose]"

  post-processors:
    name: "primary-reference"
    type: "references"
    referenceEndpoint: "$fhirResourse.extension(url=http://hl7.org/fhir/StructureDefinition/condition-related).value"
    condition:
      targetRoot: "$fhirResource"
      targetAttribute: "extension.url"
      operator: "not in"
      criteria: "[http://hl7.org/fhir/StructureDefinition/condition-related]"
    referencedResource:
      condition:
        targetRoot: "$fhirResource"
        targetAttribute: "extension.url"
        operator: "one of"
        criteria: "[http://hl7.org/fhir/StructureDefinition/condition-related]"
#Add ways to link references here, also when linking in the end the engine should search for context mappings that fit the resource added in the condition. 