engine: FHIRConnect/v0.0.1
type: context
metadata:
  name:  KDS_diagnose.context
  version: 0.0.1a # version of this particular mapping
spec: # schema specific to the FHIRConnect v0.0.1 engine
  system: FHIR
  version: R4

context:
  profileUrl: "https://www.medizininformatik-initiative.de/fhir/core/modul-diagnose/StructureDefinition/Diagnose"
  templateId: "KDS_Diagnose"
  archetypes:
    - "openEHR-EHR-CLUSTER.multiple_coding_icd10gm.v1" # i dont think we need to list clusters here ?
    - "openEHR-EHR-EVALUATION.problem_diagnosis.v1"
    - "openEHR-EHR-CLUSTER.problem_qualifier.v2"
    - "openEHR-EHR-CLUSTER.lebensphase.v0"
    - "openEHR-EHR-CLUSTER.case_identification.v0"
  extensions:
    - "KDSProblemDiagnosis" #they overload the vanilla mappings, no version = take the latest
    - "KDSProblemQualifier"
    - "KDSLebensphase"
  start: "EVALUATION.problem_diagnosis.v1"

fhir:
  post-processors:
    name: "primary-reference"
    referenceEndpoint: "$resource.extension(url=http://hl7.org/fhir/StructureDefinition/condition-related).value"
    condition:
      targetRoot: "$resource"
      targetAttribute: "extension.url"
      operator: "not of"
      criteria: "[http://hl7.org/fhir/StructureDefinition/condition-related]"
    referencedResource:
      condition:
        target: "$resource.extension.url"
        operator: "one of"
        criteria: "[http://hl7.org/fhir/StructureDefinition/condition-related]"

#Add ways to link references here, also when linking in the end the engine should search for context mappings that fit the resource added in the condition. 