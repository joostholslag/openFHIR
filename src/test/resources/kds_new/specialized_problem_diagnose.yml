format: "0.2.0"
version: "0.0.1"

openEhrConfig:
  archetype: "openEHR-EHR-EVALUATION.problem_diagnosis.v1"
  type: "profiled" # maybe add here another type, or in the generc config we are introducing 
  id: "KDS_openEHR-EHR-EVALUATION.problem_diagnosis.v1" # to reference in the context.

mappings:
  - name: "date" 
    profiling: "add" # add, overwrite, append/ Profiling is the wrong word 
    with:
      fhir: "$fhirResource.extension.value.as(DateTimeType)"
      openehr: "data[at0001]/items[at0003]"
      type: "DATETIME"
    condition:
      targetRoot: "$fhirRoot.extension"
      targetAttribute: "url"
      operator: "one of"
      criteria: "[http://hl7.org/fhir/StructureDefinition/condition-assertedDate]"

 - name: "icd10ProblemDiagnose" 
    profiling: "append" # add, overwrite, append/ Profiling is the wrong word 
    appendTo: "$problemDiagnoseName"
      condition:
        targetRoot: "coding"
        targetAttribute: "system"
        operator: "one of"
        criteria: "[http://fhir.de/CodeSystem/bfarm/icd-10-gm]"
      followedBy:
          mappings:    
            - name: "code icd 10, diagnosesicherheit"
              with:
                fhir: "extension"
                openehr: "$openEhrArchetype.diagnosesicherheit"
                type: "CODEABLECONCEPT"
              condition:
                targetRoot: "extension"
                targetAttribute: "url"
                operator: "one of"
                criteria: "[http://fhir.de/StructureDefinition/icd-10-gm-diagnosesicherheit]"


  -name: "lebensphase" # if append name needs to be the same we are appending to
   profiling: "append"  #another way could be 
   appendTo: "$DateTimePeriod" # added dollar here, to seperate it from the following yaml paths ?
   # YAML path see -> https://github.com/wwkimball/yamlpath/wiki/Segments-of-a-YAML-Path
   followedBy:
      mappings:
        - name: "period onset start"
          with:
            fhir: "start.extension.value"
            openehr: "lebensphase.beginn"
            type: "CODEABLECONCEPT"
          condition:
            targetRoot: "start.extension"
            targetAttribute: "url"
            operator: "one of"
            criteria: "[http://fhir.de/StructureDefinition/lebensphase]"

        - name: "period onset end"
          with:
            fhir: "end.extension.value"
            openehr: "lebensphase.ende"
            type: "CODEABLECONCEPT"
          condition:
            targetRoot: "end.extension"
            targetAttribute: "url"
            operator: "one of"
            criteria: "[http://fhir.de/StructureDefinition/lebensphase]"


  - name: "snomedBodySite" 
    profiling: "append"
    path: "$bodySiteCode" # if wanted to add to the where it would be bodySiteCode.where, see YAML paths. if there is EVER the case that people need to add something
    # in the middle of the where they can use overwrite we will just support appending to the end. 
    condition: 
      targetRoot: "coding"
      targetAttribute: "system"
      operator: "one of"
      criteria: "[http://snomed.info/sct]"

 - name: "clinicalStatus"
    with:
      fhir: "$fhirResource"
      openehr: "/data[at0001]/items[openEHR-EHR-CLUSTER.problem_qualifier.v2]"
    slotArchetype: "openEHR-EHR-CLUSTER.problem_qualifier.v2"  #see OMOCL https://github.com/SevKohler/OMOCL/blob/536e9562e5c97cd66eb6b259692b4a672568192b/medical_data/observation/Laboratory_test_result_v1.yml#L9

- name: "ReferenzPrimaerdiagnose"
  with:
    fhir: "$fhirResource.extension.value.as(Condition)"
    openehr: "/data[at0001]/items[openEHR-EHR-CLUSTER.problem_qualifier.v2]/items[at0063]"
    # if fhir contains a reference -> set at0064
    # if openEHR contains e.g. at0063 then set FHIR ReferenzPrimaerdiagnose 
    # check all problem diagnoses and set the one that has 0064. 
    # i think this is maybe what needs to be inline coding. 
    # this needs to be in the context since it needs to be kind of done when all the resources are there, linking them. 
    type: "MANUAL" #The manual mapping we could do here still
      openEHR:
        code: "at0064"
        system: "local" #correct
        display: "local" #correct

      FHIR:
        #linke hauptdiagnose ?!        
        condition:
          targetRoot: "/items[at0066]"
          targetAttribute:
          operator: "one of"
          criteria: "at0064"
  condition:
    targetRoot: "$fhirRoot.extension"
    targetAttribute: "url"
    operator: "one of"
    criteria: "[http://hl7.org/fhir/StructureDefinition/condition-related]"





# for this i think we need kind of method calling 
              - name: "code icd 10, mehrfachcodierungs"
                with:
                  fhir: "extension"
                  openehr: "$openEhrArchetype.multiple_coding_icd-10-gm.multiple_coding_identifier"
                  type: "CODEABLECONCEPT"
                condition:
                  targetRoot: "extension"
                  targetAttribute: "url"
                  operator: "one of"
                  criteria: "[http://fhir.de/StructureDefinition/icd-10-gm-mehrfachcodierungs-kennzeichen]"

              - name: "code icd 10, seitenlokalisation"
                with:
                  fhir: "extension"
                  openehr: "$openEhrArchetype.anatomical_location.laterality"
                  type: "CODEABLECONCEPT"
                condition:
                  targetRoot: "extension"
                  targetAttribute: "url"
                  operator: "one of"
                  criteria: "[http://fhir.de/StructureDefinition/seitenlokalisation]"